/*!
 * PjaxRouter v2.0.0
 * https://github.com/yomotsu/PjaxRouter
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).PjaxRouter=e()}(this,function(){"use strict";class t{constructor(e){if(this.lastStartTime=-1,this._listeners={},!t.supported)return;this.url=location.href,this.timeout=e.timeout||5e3,this.triggers=e.triggers||[],this.formTriggers=e.formTriggers||[],this.ignores=e.ignores||[],this.selectors=e.selectors,this.switches=e.switches,this._onLinkClick=t=>this.onLinkClick(t),this._onFormSubmit=t=>this.onFormSubmit(t),this._onPopstate=t=>this.onPopstate(t);const o={url:window.location.href,scrollTop:document.body.scrollTop||document.documentElement.scrollTop};window.history.replaceState(o,document.title),document.body.addEventListener("click",this._onLinkClick),document.addEventListener("submit",this._onFormSubmit,!0),window.addEventListener("popstate",this._onPopstate)}pageTransition(t){this.emit("beforeswitch"),this.selectors.forEach(e=>{const o=document.querySelector(e),s=t.querySelector(e);o&&s&&"function"==typeof this.switches[e]&&this.switches[e].call(this,s,o)}),this.emit("afterswitch")}async load(t,e=!1,o={}){this.emit("beforeload",{nextUrl:t});const s=Date.now();this.url=t,this.lastStartTime=s;try{const t=await async function(t,e,o=5e3,s={}){var i;const r=Date.now(),n=new AbortController,l=setTimeout(()=>n.abort(),o);try{const o={method:s.method||"GET",signal:n.signal};s.body&&(o.body=s.body),s.headers&&(o.headers=s.headers);const a=await fetch(t,o);if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const c=null===(i=a.body)||void 0===i?void 0:i.getReader(),h=parseInt(a.headers.get("Content-Length")||"0",10);if(!c){const t=await a.text();return clearTimeout(l),{text:t,progress:{loaded:t.length,total:t.length,elapsedTime:Date.now()-r}}}let u=0;const d=[];for(;;){const{done:t,value:o}=await c.read();if(t)break;d.push(o),u+=o.length,e&&e({loaded:u,total:h||u,elapsedTime:Date.now()-r})}clearTimeout(l);const m=new Blob(d);return{text:await m.text(),progress:{loaded:u,total:h||u,elapsedTime:Date.now()-r}}}catch(t){if(clearTimeout(l),t instanceof Error&&"AbortError"===t.name)throw new Error("Request timeout");throw t}}(this.url,t=>this.emit("loading",t),this.timeout,o),i=(new DOMParser).parseFromString(t.text,"text/html");if(!e){const t=i.querySelector("title"),e=t?t.innerHTML:this.url,o={url:this.url,scrollTop:document.body.scrollTop||document.documentElement.scrollTop};history.pushState(o,e,this.url)}if(this.lastStartTime!==s)return;this.emit("load",t.progress),this.pageTransition(i)}catch(t){this.emit("error",t),location.href=this.url}}on(t,e,o){this._listeners[t]||(this._listeners[t]=[]);const s={callback:e,once:(null==o?void 0:o.once)||!1};this._listeners[t].some(t=>t.callback===e)||this._listeners[t].push(s)}once(t,e){this.on(t,e,{once:!0})}off(t,e){if(!this._listeners[t])return;if(!e)return void delete this._listeners[t];const o=this._listeners[t],s=o.findIndex(t=>t.callback===e);-1!==s&&o.splice(s,1)}emit(t,e){const o=this._listeners[t];o&&(this._listeners[t]=o.filter(t=>(t.callback.call(this,e),!t.once)))}onLinkClick(t){if(!(t.target instanceof Element))return;const e=new RegExp(location.origin),o=t.target;let s=null;const i=this.triggers.some(t=>{const e=o.closest(t);return!!e&&(s=e,!0)}),r=this.ignores.some(t=>!!o.closest(t));if(!i||r||!s)return;const n=s;!e.test(n.href)||n.href.includes("#")&&this.url.replace(/#.*$/,"")===n.href.replace(/#.*$/,"")||(t.preventDefault(),this.load(n.href))}onFormSubmit(t){if(!(t.target instanceof Element))return;const e=new RegExp(location.origin),o=t.target;let s=null;const i=this.formTriggers.some(t=>{const e=o.closest(t);return!!e&&(s=e,!0)}),r=this.ignores.some(t=>!!o.closest(t));if(!i||r||!s)return;const n=s,l=(n.method||"GET").toUpperCase(),a=function(t){return"GET"===t||"POST"===t||"PUT"===t||"PATCH"===t||"DELETE"===t||"HEAD"===t||"OPTIONS"===t}(l)?l:"GET",c=n.action||location.href;if(!e.test(c))return;t.preventDefault();const h=new FormData(n);if("GET"===a||"HEAD"===a){const t=new URLSearchParams;h.forEach((e,o)=>{"string"==typeof e&&t.append(o,e)});const e=c.split("?")[0]+"?"+t.toString();this.load(e,!1,{method:a})}else this.load(c,!1,{method:a,body:h})}onPopstate(t){var e;(e=t.state)&&"object"==typeof e&&"string"==typeof e.url&&"number"==typeof e.scrollTop&&this.load(t.state.url,!0)}}return t.supported=!(!window.history||!window.history.pushState),t});
//# sourceMappingURL=PjaxRouter.min.js.map
