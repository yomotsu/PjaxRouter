!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.PjaxRouter=e()}(this,function(){"use strict";var c=new XMLHttpRequest,n=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector;var r=9;function s(t,e){for(;t&&t.nodeType!==r;){if(o=t,i=e,n.call(o,i))return t;t=t.parentNode}var o,i}var t=function(){function e(t){void 0===t&&(t={}),e.supported&&(this.lastStartTime=-1,this.url=location.href,this.xhrTimeout=t.xhrTimeout||5e3,this.triggers=t.triggers||[],this.ignores=t.ignores||[],this.selectors=t.selectors,this.switches=t.switches,this._listeners={},this._onLinkClick=function(e){var o,t=this.triggers.some(function(t){return!!(o=s(e.target,t))}),i=this.ignores.some(function(t){return!!s(e.target,t)});if(!t||i)return;if(!l.test(o.href))return;if(e.preventDefault(),this.url===o.href)return;this.load(o.href)}.bind(this),this._onPopstate=function(t){if(!t.state)return;this.load(t.state.url,!0)}.bind(this),window.history.replaceState({url:window.location.href,scrollTop:document.body.scrollTop||document.documentElement.scrollTop},document.title),document.body.addEventListener("click",this._onLinkClick),window.addEventListener("popstate",this._onPopstate))}var t=e.prototype;return t.pageTransition=function(i){var n=this;this.emit("beforeswitch",{nextUrl:url}),this.selectors.forEach(function(t){var e=document.querySelector(t),o=i.querySelector(t);"function"==typeof n.switches[t]&&n.switches[t].bind(n)(o,e)}),this.emit("afterswitch")},t.load=function(t,r){var s=this;this.emit("beforeload");var l=Date.now();this.url=t,this.lastStartTime=l,function(t,e,o,i){void 0===i&&(i=5e3);var n=Date.now();c.open("GET",t,!0),c.timeout=i,c.onload=function(t){e(c.responseText,{loaded:t.loaded,total:t.total,elapsedTime:Date.now()-n})},c.ontimeout=function(){e(null)},c.onerror=function(){e(null)},c.onprogress=function(t){o({loaded:t.loaded,total:t.total,elapsedTime:Date.now()-n})},c.send(null)}(this.url,function(t,e){if(!t)return s.emit("error"),void(location.href=s.url);var o=(new DOMParser).parseFromString(t,"text/html");if(!r){var i=!!o.querySelector("title").innerHTML||s.url,n={url:s.url,scrollTop:document.body.scrollTop||document.documentElement.scrollTop};history.pushState(n,i,s.url)}s.lastStartTime===l&&(s.emit("load",e),s.pageTransition(o))},function(t){s.emit("loading",t)},this.xhrTimeout)},t.on=function(t,e,o){this._listeners[t]||(this._listeners[t]=[]);var i={callback:e,once:o&&o.once||!1};this._listeners[t].some(function(t){return t.listener===e})||this._listeners[t].push(i)},t.once=function(t,e){this.on(t,e,{once:!0})},t.off=function(t,e){if(this._listeners[t])if(e){for(var o=this._listeners[t],i=0,n=o.length;i<n;i+=1)if(o[i].callback===e)return void o.splice(i,1)}else delete this._listeners[t]},t.emit=function(t,e){var o=this,i=this._listeners[t];i&&(this._listeners[t]=i.filter(function(t){return t.callback.call(o,e),!t.once}))},e}();t.supported=window.history&&window.history.pushState;var l=new RegExp(location.origin);return t});
