!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.PjaxRouter=e()}(this,function(){"use strict";function t(t,e){return n.call(t,e)}function e(e,o){for(;e&&e.nodeType!==i;){if(t(e,o))return e;e=e.parentNode}}var o=new XMLHttpRequest,n=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector,i=9,r=function(){function t(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),t.supported&&(this.lastStartTime=-1,this.url=location.href,this.xhrTimeout=o.xhrTimeout||5e3,this.triggers=o.triggers||[],this.ignores=o.ignores||[],this.selectors=o.selectors,this.switches=o.switches,this._listeners={},this._onLinkClick=function(t){var o=void 0,n=this.triggers.some(function(n){return!!(o=e(t.target,n))}),i=this.ignores.some(function(o){return!!e(t.target,o)});n&&!i&&(!s.test(o.href)||(t.preventDefault(),this.url!==o.href&&this.load(o.href)))}.bind(this),this._onPopstate=function(t){t.state&&this.load(t.state.url,!0)}.bind(this),window.history.replaceState({url:window.location.href,scrollTop:document.body.scrollTop||document.documentElement.scrollTop},document.title),document.body.addEventListener("click",this._onLinkClick),window.addEventListener("popstate",this._onPopstate))}return t.prototype.pageTransition=function(t){var e=this;this.emit("beforeswitch"),this.selectors.forEach(function(o){var n=document.querySelector(o),i=t.querySelector(o);"function"==typeof e.switches[o]&&e.switches[o].bind(e)(i,n)}),this.emit("afterswitch")},t.prototype.load=function(t,e){var n=this;this.emit("beforeload");var i=Date.now();this.url=t,this.lastStartTime=i,function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5e3,r=Date.now();o.open("GET",t,!0),o.timeout=i,o.onload=function(t){e(o.responseText,{loaded:t.loaded,total:t.total,elapsedTime:Date.now()-r})},o.ontimeout=function(){e(null)},o.onerror=function(){e(null)},o.onprogress=function(t){n({loaded:t.loaded,total:t.total,elapsedTime:Date.now()-r})},o.send(null)}(this.url,function(t,o){if(!t)return n.emit("error"),void(location.href=n.url);var r=(new DOMParser).parseFromString(t,"text/html");if(!e){var s=!!r.querySelector("title").innerHTML||n.url,l={url:n.url,scrollTop:document.body.scrollTop||document.documentElement.scrollTop};history.pushState(l,s,n.url)}n.lastStartTime===i&&(n.emit("load",o),n.pageTransition(r))},function(t){n.emit("loading",t)},this.xhrTimeout)},t.prototype.on=function(t,e,o){this._listeners[t]||(this._listeners[t]=[]);var n={callback:e,once:o&&o.once||!1};this._listeners[t].some(function(t){return t.listener===e})||this._listeners[t].push(n)},t.prototype.once=function(t,e){this.on(t,e,{once:!0})},t.prototype.off=function(t,e){if(this._listeners[t])if(e){for(var o=this._listeners[t],n=0,i=o.length;n<i;n+=1)if(o[n].callback===e)return void o.splice(n,1)}else delete this._listeners[t]},t.prototype.emit=function(t,e){var o=this,n=this._listeners[t];n&&(this._listeners[t]=n.filter(function(t){return t.callback.call(o,e),!t.once}))},t}();r.supported=window.history&&window.history.pushState;var s=new RegExp(location.origin);return r});
